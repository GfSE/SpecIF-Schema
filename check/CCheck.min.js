var CCheck=function(){this.ajv=new Ajv({allErrors:!0})};CCheck.prototype.checkSchema=function(e,k){if(!k||!k.schema)throw Error("checkSchema options: a schema must be supplied");var r=this.ajv.compile(k.schema);return r(e)?{status:0,statusText:"SpecIF schema has been checked successfully!"}:{status:970,statusText:"SpecIF schema is violated",responseType:"text",responseText:this.ajv.errorsText(r.errors)}};
CCheck.prototype.checkConstraints=function(e,k){function r(c,f){Array.isArray(c.propertyClasses)&&("resourceClass"==f&&!c["extends"]&&1>c.propertyClasses.length&&g.push({status:976,statusText:"resource class '"+c.id+"' must have at least one property class"}),c.propertyClasses.forEach(function(a){q(e.propertyClasses,a)&&g.push({status:977,statusText:"property class '"+a.id+"' of element '"+c.id+"' must reference an item in 'propertyClasses'"})}))}function u(c,f,a,b){f.forEach(function(d){d[a]&&q(c,
d[a])&&g.push({status:979,statusText:"key '"+a+"' of item with identifier '"+d.id+"' must reference a valid "+b})})}function v(c,f,a){var b=p(e.dataTypes,c.dataType);b&&Array.isArray(f)&&(!(c.multiple||"boolean"!=typeof c.multiple&&b.multiple)&&1<f.length&&g.push({status:983,statusText:a+": neither propertyClass nor dataType allow multiple values"}),f.forEach(function(d){if(Array.isArray(b.enumeration))("string"!=typeof d||q(b.enumeration,{id:d}))&&g.push({status:984,statusText:a+": all values must be an id of the dataTypes' value enumeration"});
else{switch(b.type){case "xs:string":if(!w(d)){g.push({status:985,statusText:a+": all values must be a list (of multi-language objects)"});return}break;default:if("string"!=typeof d){g.push({status:985,statusText:a+": all values must be a string"});return}}switch(b.type){case "xs:boolean":"true"!=d&&"false"!=d&&g.push({status:986,statusText:a+": boolean value is invalid"});break;case "xs:dateTime":0<x.checkSchema({value:d},{schema:{$id:"https://specif.de/v1.1/dateTime/schema#",$schema:"http://json-schema.org/draft-04/schema#",
type:"object",properties:{value:{type:"string",format:"date-time"}}}}).status&&g.push({status:986,statusText:a+": value must be a valid date-time string according to ISO 8601"});break;case "xs:anyURI":0<x.checkSchema({value:d},{schema:{$id:"https://specif.de/v1.1/anyURI/schema#",$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{value:{type:"string",format:"uri"}}}}).status&&g.push({status:986,statusText:a+": value must be a valid URI string according to RFC 3986"});break;
case "xs:integer":d=parseInt(d);isNaN(d)&&g.push({status:986,statusText:a+": value is not a valid number"});b.minInclusive&&d<b.minInclusive&&g.push({status:986,statusText:a+": integer value must be larger than "+b.minInclusive});b.maxInclusive&&d>b.maxInclusive&&g.push({status:986,statusText:a+": integer value must be smaller than "+b.maxInclusive});break;case "xs:double":d=parseFloat(d);isNaN(d)&&g.push({status:986,statusText:a+": value is not a valid number"});b.minInclusive&&d<b.minInclusive&&
g.push({status:986,statusText:a+": double value must be larger than "+b.minInclusive});b.maxInclusive&&d>b.maxInclusive&&g.push({status:986,statusText:a+": double value must be smaller than "+b.maxInclusive});break;case "xs:string":Array.isArray(d)?"number"==typeof b.maxLength&&0>k.dontCheck.indexOf("text.length")&&d.forEach(function(l){l.text.length>b.maxLength&&0>k.dontCheck.indexOf("text.length")&&g.push({status:986,statusText:a+": length of string value must not exceed "+b.maxLength})}):g.push({status:986,
statusText:a+": value must be a list of multi-language objects"})}}}))}function y(c,f,a){f.forEach(function(b){function d(h){l=l.concat(h.propertyClasses||[]);"object"==typeof h["extends"]&&d(p(c,h["extends"]))}var l=[],m,n,t=p(c,b[a]);t&&(d(t),Array.isArray(b.properties)&&b.properties.forEach(function(h){m="property with class '"+h["class"].id+"' of instance with identifier '"+b.id+"'";q(l,h["class"])&&g.push({status:987,statusText:m+": class must be listed with the instance class or a parent instance class"});
n=p(e.propertyClasses,h["class"]);"object"==typeof n?v(n,h.values,m):g.push({status:987,statusText:m+" must reference a valid propertyClass"})}))})}function z(c,f,a){Array.isArray(f)&&f.forEach(function(b){q(c,b.resource)&&g.push({status:988,statusText:"hierarchy node with identifier '"+b.id+"' must reference a valid resource"});z(c,b.nodes,a+1)})}function A(c){return{id:c.id,revision:c.revision}}function w(c){if(Array.isArray(c)){for(var f=1<c.length,a=c.length-1;-1<a;a--)if("string"!=typeof c[a].text||
f&&("string"!=typeof c[a].language||2>c[a].language.length))return!1;return!0}return!1}function p(c,f){var a=c.filter(function(b){return b.id==f.id});if(!(1>a.length)){if(1==a.length&&!a[0].revision)return f.revision?void 0:a[0];a.sort(function(b,d){return d.changedAt-b.changedAt});if(!f.revision)return a[0];a=a.filter(function(b){return b.revision==f.revision});if(0<a.length)return a[0]}}function q(c,f){return void 0==p(c,f)}function B(c){var f="";c.forEach(function(a){f+=(f.length?",\n":"")+a.statusText+
" ("+status+")"});return f}if(e.specifVersion)return{status:971,statusText:"This constraint checker does not support any SpecIF version below 1.1"};switch(e.$schema){case "https://specif.de/v1.1/schema.json":case "https://json.schemastore.org/specif-1.1.json":break;case "https://specif.de/v1.0/schema.json":case "https://json.schemastore.org/specif-1.0.json":return{status:971,statusText:"This constraint checker does not support SpecIF version 1.0"};default:return{status:972,statusText:"Invalid schema location"}}"object"!=
typeof k&&(k={});Array.isArray(k.doCheck)||(k.doCheck=[]);Array.isArray(k.dontCheck)||(k.dontCheck=[]);var x=this,g=[];(function(){function c(a){if(Array.isArray(a)&&0<a.length)for(var b,d=a.length-1;-1<d;d--)if(void 0!=a[d].id){a:{for(var l=a[d],m=l.revision||"",n=f.length-1;-1<n;n--)if(b=f[n].revision||"",f[n].id==l.id&&(b==m||""==b||""==m)){b=!0;break a}b=!1}if(b)return a[d];if((b=c(a[d].enumeration))||(b=c(a[d].nodes)))return b;f.push(A(a[d]))}}var f=[A(e)];[{list:e.dataTypes,name:"dataType or enumerated value"},
{list:e.propertyClasses,name:"propertyClass"},{list:e.resourceClasses,name:"resourceClass"},{list:e.statementClasses,name:"statementClass"},{list:e.resources,name:"resource"},{list:e.statements,name:"statement"},{list:e.hierarchies,name:"hierarchy or node"},{list:e.files,name:"file"}].forEach(function(a){var b=c(a.list);b&&g.push({status:973,statusText:"key of "+a.name+" '"+b.id+"' with revision "+b.revision+" is not unique"})})})();(function(){e.dataTypes.forEach(function(c){switch(c.type){case "xs:double":case "xs:integer":"number"==
typeof c.minInclusive&&"number"==typeof c.maxInclusive&&c.minInclusive+1>c.maxInclusive&&g.push({status:974,statusText:"dataType '"+c.id+"': minInclusive must be smaller or equal than maxInclusive"});case "xs:dateTime":case "xs:anyURI":case "xs:string":if(Array.isArray(c.enumeration))if(0<c.enumeration.length)for(var f=c.enumeration.length-1;-1<f;f--)"xs:string"==c.type?w(c.enumeration[f].value)||g.push({status:974,statusText:"dataType '"+c.id+"' of type 'xs:string' must have enumerated values, each with a list of multi-language texts"}):
"string"!=typeof c.enumeration[f].value&&g.push({status:974,statusText:"dataType '"+c.id+"' of type '"+c.type+"' must have enumerated string values"});else g.push({status:974,statusText:"dataType '"+c.id+"' must have at least one enumerated value"})}})})();(function(){e.propertyClasses.forEach(function(c){q(e.dataTypes,c.dataType)&&g.push({status:975,statusText:"property class with identifier '"+c.id+"' must reference a valid dataType"});v(c,c.values,"property class '"+c.id+"'")})})();(function(){e.resourceClasses.forEach(function(c){r(c,
"resourceClass")});u(e.resourceClasses,e.resourceClasses,"extends","resourceClass")})();(function(){var c=e.resourceClasses.concat(e.statementClasses);e.statementClasses.forEach(function(f){r(f);["subjectClasses","objectClasses"].forEach(function(a){var b;if(b=k.doCheck.includes("statementClass."+a))a:{b=f[a];if(Array.isArray(b)){if(1>b.length){b=!0;break a}for(var d=b.length-1;-1<d;d--)if(q(c,b[d])){b=!0;break a}}b=!1}b&&g.push({status:978,statusText:a+" of class '"+f.id+"' must reference at least one valid resourceClass or statementClass"})})});
u(e.statementClasses,e.statementClasses,"extends","statementClass")})();u(e.resourceClasses,e.resources,"class","resourceClass");y(e.resourceClasses,e.resources,"class");(function(){u(e.statementClasses,e.statements,"class","statementClass");var c=e.resources.concat(e.statements),f=e.resourceClasses.concat(e.statementClasses);e.statements.forEach(function(a,b){var d=p(c,a.subject),l=p(c,a.object);!d&&0>k.dontCheck.indexOf("statement.subject")&&g.push({status:980,statusText:"subject of statement["+
b+"] with identifier '"+a.id+"' must reference a valid resource or statement"});!l&&0>k.dontCheck.indexOf("statement.object")&&g.push({status:980,statusText:"object of statement["+b+"] with identifier '"+a.id+"' must reference a valid resource or statement"});d&&l&&d.id==l.id&&d.revision!=l.revision&&g.push({status:980,statusText:"subject and object of statement["+b+"] with identifier '"+a.id+"' may have the same id, but not of different revisions"});var m=p(e.statementClasses,a["class"]);if(Array.isArray(m.subjectClasses)&&
d){var n=[];m.subjectClasses.forEach(function(h){(h=p(f,h))&&n.push(h)});q(n,d["class"])&&g.push({status:981,statusText:"the subject of statement["+b+"] with identifier '"+a.id+"' has a class which is not listed in the subjectClasses of the statement's class"})}if(Array.isArray(m.objectClasses)&&l){var t=[];m.objectClasses.forEach(function(h){(h=p(f,h))&&t.push(h)});q(t,l[["class"]])&&g.push({status:981,statusText:"the object of statement["+b+"] with identifier '"+a.id+"' has a class which is not listed in the objectClasses of the statement's class"})}});
y(e.statementClasses,e.statements,"class")})();z(e.resources,e.hierarchies,0);return 1>g.length?{status:0,statusText:"SpecIF constraints have been checked successfully!"}:{status:973,statusText:"SpecIF constraints are violated",responseType:"text",responseText:B(g)}};