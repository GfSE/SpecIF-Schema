var CCheck=function(){this.ajv=new Ajv({allErrors:!0});this.regex={IsoDateTime:/^(\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|30|31)(?:T([0-1]\d|2[0-4]):([0-5]\d):([0-5]\d(?:\.\d{1,3})?)(\+(0\d|11|12):([0-5]\d)|-(0\d|11|12):([0-5]\d)|Z)?)?$/}};
CCheck.prototype.checkSchema=function(f,k){if(!k||!k.schema)throw Error("checkSchema options: a schema must be supplied");var r=this.ajv.compile(k.schema);return r(f)?{status:0,statusText:"SpecIF schema has been checked successfully!"}:{status:970,statusText:"SpecIF schema is violated",responseType:"text",responseText:this.ajv.errorsText(r.errors)}};
CCheck.prototype.checkConstraints=function(f,k){function r(c,e){Array.isArray(c.propertyClasses)&&("resourceClass"==e&&!c["extends"]&&1>c.propertyClasses.length&&g.push({status:976,statusText:"resource class '"+c.id+"' must have at least one property class"}),c.propertyClasses.forEach(function(b){q(f.propertyClasses,b)&&g.push({status:977,statusText:"property class '"+b.id+"' of element '"+c.id+"' must reference an item in 'propertyClasses'"})}))}function u(c,e,b,a){e.forEach(function(d){d[b]&&q(c,
d[b])&&g.push({status:979,statusText:"key '"+b+"' of item with identifier '"+d.id+"' must reference a valid "+a})})}function v(c,e,b){var a=p(f.dataTypes,c.dataType);a&&Array.isArray(e)&&(!(c.multiple||"boolean"!=typeof c.multiple&&a.multiple)&&1<e.length&&g.push({status:983,statusText:b+": neither propertyClass nor dataType allow multiple values"}),e.forEach(function(d){if(Array.isArray(a.enumeration))("string"!=typeof d||q(a.enumeration,{id:d}))&&g.push({status:984,statusText:b+": all values must be an id of the dataTypes' value enumeration"});
else{switch(a.type){case "xs:string":if(!w(d)){g.push({status:985,statusText:b+": all values must be a list (of multi-language objects)"});return}break;default:if("string"!=typeof d){g.push({status:985,statusText:b+": all values must be a string"});return}}switch(a.type){case "xs:boolean":"true"!=d&&"false"!=d&&g.push({status:986,statusText:b+": boolean value is invalid"});break;case "xs:dateTime":x.regex.IsoDateTime.test(d)||g.push({status:986,statusText:b+": value must be a valid date-time string according to ISO 8601"});
break;case "xs:anyURI":0<x.checkSchema({value:d},{schema:{$id:"https://specif.de/v1.1/anyURI/schema#",$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{value:{type:"string",format:"uri"}}}}).status&&g.push({status:986,statusText:b+": value must be a valid URI string according to RFC 3986"});break;case "xs:integer":d=parseInt(d);isNaN(d)&&g.push({status:986,statusText:b+": value is not a valid number"});a.minInclusive&&d<a.minInclusive&&g.push({status:986,statusText:b+": integer value must be larger than "+
a.minInclusive});a.maxInclusive&&d>a.maxInclusive&&g.push({status:986,statusText:b+": integer value must be smaller than "+a.maxInclusive});break;case "xs:double":d=parseFloat(d);isNaN(d)&&g.push({status:986,statusText:b+": value is not a valid number"});a.minInclusive&&d<a.minInclusive&&g.push({status:986,statusText:b+": double value must be larger than "+a.minInclusive});a.maxInclusive&&d>a.maxInclusive&&g.push({status:986,statusText:b+": double value must be smaller than "+a.maxInclusive});break;
case "xs:string":Array.isArray(d)?"number"==typeof a.maxLength&&0>k.dontCheck.indexOf("text.length")&&d.forEach(function(l){l.text.length>a.maxLength&&0>k.dontCheck.indexOf("text.length")&&g.push({status:986,statusText:b+": length of string value must not exceed "+a.maxLength})}):g.push({status:986,statusText:b+": value must be a list of multi-language objects"})}}}))}function y(c,e,b){e.forEach(function(a){function d(h){l=l.concat(h.propertyClasses||[]);"object"==typeof h["extends"]&&d(p(c,h["extends"]))}
var l=[],m,n,t=p(c,a[b]);t&&(d(t),Array.isArray(a.properties)&&a.properties.forEach(function(h){m="property with class '"+h["class"].id+"' of instance with identifier '"+a.id+"'";q(l,h["class"])&&g.push({status:987,statusText:m+": class must be listed with the instance class or a parent instance class"});n=p(f.propertyClasses,h["class"]);"object"==typeof n?v(n,h.values,m):g.push({status:987,statusText:m+" must reference a valid propertyClass"})}))})}function z(c,e,b){Array.isArray(e)&&e.forEach(function(a){q(c,
a.resource)&&g.push({status:988,statusText:"hierarchy node with identifier '"+a.id+"' must reference a valid resource"});z(c,a.nodes,b+1)})}function A(c){return{id:c.id,revision:c.revision}}function w(c){if(Array.isArray(c)){for(var e=1<c.length,b=c.length-1;-1<b;b--){var a=c[b];if("string"!=typeof a.text||e&&0<b&&("string"!=typeof a.language||2>a.language.length))return!1}return!0}return!1}function p(c,e){var b=c.filter(function(a){return a.id==e.id});if(!(1>b.length)){if(1==b.length&&!b[0].revision)return e.revision?
void 0:b[0];b.sort(function(a,d){return d.changedAt-a.changedAt});if(!e.revision)return b[0];b=b.filter(function(a){return a.revision==e.revision});if(0<b.length)return b[0]}}function q(c,e){return void 0==p(c,e)}function B(c){var e="";c.forEach(function(b){e+=(e.length?",\n":"")+b.statusText+" ("+status+")"});return e}if(f.specifVersion)return{status:971,statusText:"This constraint checker does not support any SpecIF version below 1.1"};switch(f.$schema){case "https://specif.de/v1.1/schema.json":case "https://json.schemastore.org/specif-1.1.json":break;
case "https://specif.de/v1.0/schema.json":case "https://json.schemastore.org/specif-1.0.json":return{status:971,statusText:"This constraint checker does not support SpecIF version 1.0"};default:return{status:972,statusText:"Invalid schema location"}}"object"!=typeof k&&(k={});Array.isArray(k.doCheck)||(k.doCheck=[]);Array.isArray(k.dontCheck)||(k.dontCheck=[]);var x=this,g=[];(function(){function c(b){if(Array.isArray(b)&&0<b.length)for(var a,d=b.length-1;-1<d;d--)if(void 0!=b[d].id){a:{for(var l=
b[d],m=l.revision||"",n=e.length-1;-1<n;n--)if(a=e[n].revision||"",e[n].id==l.id&&(a==m||""==a||""==m)){a=!0;break a}a=!1}if(a)return b[d];if((a=c(b[d].enumeration))||(a=c(b[d].nodes)))return a;e.push(A(b[d]))}}var e=[A(f)];[{list:f.dataTypes,name:"dataType or enumerated value"},{list:f.propertyClasses,name:"propertyClass"},{list:f.resourceClasses,name:"resourceClass"},{list:f.statementClasses,name:"statementClass"},{list:f.resources,name:"resource"},{list:f.statements,name:"statement"},{list:f.hierarchies,
name:"hierarchy or node"},{list:f.files,name:"file"}].forEach(function(b){var a=c(b.list);a&&g.push({status:973,statusText:"key of "+b.name+" '"+a.id+"' with revision "+a.revision+" is not unique"})})})();(function(){f.dataTypes.forEach(function(c){switch(c.type){case "xs:double":case "xs:integer":"number"==typeof c.minInclusive&&"number"==typeof c.maxInclusive&&c.minInclusive+1>c.maxInclusive&&g.push({status:974,statusText:"dataType '"+c.id+"': minInclusive must be smaller or equal than maxInclusive"});
case "xs:dateTime":case "xs:anyURI":case "xs:string":if(Array.isArray(c.enumeration))if(0<c.enumeration.length)for(var e=c.enumeration.length-1;-1<e;e--)"xs:string"==c.type?w(c.enumeration[e].value)||g.push({status:974,statusText:"dataType '"+c.id+"' of type 'xs:string' must have enumerated values, each with a list of multi-language texts"}):"string"!=typeof c.enumeration[e].value&&g.push({status:974,statusText:"dataType '"+c.id+"' of type '"+c.type+"' must have enumerated string values"});else g.push({status:974,
statusText:"dataType '"+c.id+"' must have at least one enumerated value"})}})})();(function(){f.propertyClasses.forEach(function(c){q(f.dataTypes,c.dataType)&&g.push({status:975,statusText:"property class with identifier '"+c.id+"' must reference a valid dataType"});v(c,c.values,"property class '"+c.id+"'")})})();(function(){f.resourceClasses.forEach(function(c){r(c,"resourceClass")});u(f.resourceClasses,f.resourceClasses,"extends","resourceClass")})();(function(){var c=f.resourceClasses.concat(f.statementClasses);
f.statementClasses.forEach(function(e){r(e);["subjectClasses","objectClasses"].forEach(function(b){if(k.doCheck.includes("statementClass."+b)){var a=e[b];a=Array.isArray(a)&&1>a.length?!0:!1;a&&g.push({status:978,statusText:b+" of class '"+e.id+"' must reference at least one valid resourceClass or statementClass"});a:{a=e[b];if(Array.isArray(a))for(var d=a.length-1;-1<d;d--)if(q(c,a[d])){a=!0;break a}a=!1}a&&g.push({status:978,statusText:b+" of class '"+e.id+"' references at least one invalid resourceClass or statementClass"})}})});
u(f.statementClasses,f.statementClasses,"extends","statementClass")})();u(f.resourceClasses,f.resources,"class","resourceClass");y(f.resourceClasses,f.resources,"class");(function(){u(f.statementClasses,f.statements,"class","statementClass");var c=f.resources.concat(f.statements),e=f.resourceClasses.concat(f.statementClasses);f.statements.forEach(function(b,a){var d=p(c,b.subject),l=p(c,b.object);!d&&0>k.dontCheck.indexOf("statement.subject")&&g.push({status:980,statusText:"subject of statement["+
a+"] with identifier '"+b.id+"' must reference a valid resource or statement"});!l&&0>k.dontCheck.indexOf("statement.object")&&g.push({status:980,statusText:"object of statement["+a+"] with identifier '"+b.id+"' must reference a valid resource or statement"});d&&l&&d.id==l.id&&d.revision!=l.revision&&g.push({status:980,statusText:"subject and object of statement["+a+"] with identifier '"+b.id+"' may have the same id, but not of different revisions"});var m=p(f.statementClasses,b["class"]);if(Array.isArray(m.subjectClasses)&&
d){var n=[];m.subjectClasses.forEach(function(h){(h=p(e,h))&&n.push(h)});q(n,d["class"])&&g.push({status:981,statusText:"the subject of statement["+a+"] with identifier '"+b.id+"' has a class which is not listed in the subjectClasses of the statement's class"})}if(Array.isArray(m.objectClasses)&&l){var t=[];m.objectClasses.forEach(function(h){(h=p(e,h))&&t.push(h)});q(t,l[["class"]])&&g.push({status:981,statusText:"the object of statement["+a+"] with identifier '"+b.id+"' has a class which is not listed in the objectClasses of the statement's class"})}});
y(f.statementClasses,f.statements,"class")})();z(f.resources,f.hierarchies,0);return 1>g.length?{status:0,statusText:"SpecIF constraints have been checked successfully!"}:{status:973,statusText:"SpecIF constraints are violated",responseType:"text",responseText:B(g)}};