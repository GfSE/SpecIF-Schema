'use strict';class CCheck{constructor(){this.ajv=new Ajv({allErrors:!0});this.regex={IsoDateTime:/^(\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|30|31)(?:T([0-1]\d|2[0-4]):([0-5]\d):([0-5]\d(?:\.\d{1,3})?)(\+(0\d|11|12):([0-5]\d)|-(0\d|11|12):([0-5]\d)|Z)?)?$/}}checkSchema(f,h){if(!h||!h.schema)throw Error("checkSchema options: a schema must be supplied");h=this.ajv.compile(h.schema);return h(f)?{status:0,statusText:"SpecIF schema has been checked successfully!"}:{status:970,statusText:"SpecIF schema is violated",
responseType:"text",responseText:this.ajv.errorsText(h.errors)}}checkConstraints(f,h){function u(a,e){Array.isArray(a.propertyClasses)&&("resourceClass"==e&&!a["extends"]&&1>a.propertyClasses.length&&g.push({status:976,statusText:"resource class '"+a.id+"' must have at least one property class"}),a.propertyClasses.forEach(function(c){q(f.propertyClasses,c)&&g.push({status:977,statusText:"property class '"+c.id+"' of element '"+a.id+"' must reference an item in 'propertyClasses'"})}))}function t(a,
e,c,b){e.forEach(function(d){d[c]&&q(a,d[c])&&g.push({status:979,statusText:"key '"+c+"' of item with identifier '"+d.id+"' must reference a valid "+b})})}function v(a,e,c){let b=p(f.dataTypes,a.dataType);b&&Array.isArray(e)&&(!(a.multiple||"boolean"!=typeof a.multiple&&b.multiple)&&1<e.length&&g.push({status:983,statusText:c+": neither propertyClass nor dataType allow multiple values"}),e.forEach(function(d){if(Array.isArray(b.enumeration))("string"!=typeof d||q(b.enumeration,{id:d}))&&g.push({status:984,
statusText:c+": all values must be an id of the dataTypes' value enumeration"});else{switch(b.type){case "xs:string":if(!w(d)){g.push({status:985,statusText:c+": all values must be a list (of multi-language objects)"});return}break;default:if("string"!=typeof d){g.push({status:985,statusText:c+": all values must be a string"});return}}switch(b.type){case "xs:boolean":"true"!=d&&"false"!=d&&g.push({status:986,statusText:c+": boolean value is invalid"});break;case "xs:dateTime":x.regex.IsoDateTime.test(d)||
g.push({status:986,statusText:c+": value must be a valid date-time string according to ISO 8601"});break;case "xs:anyURI":0<x.checkSchema({value:d},{schema:{$id:"https://specif.de/v1.1/anyURI/schema#",$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{value:{type:"string",format:"uri"}}}}).status&&g.push({status:986,statusText:c+": value must be a valid URI string according to RFC 3986"});break;case "xs:integer":d=parseInt(d);isNaN(d)&&g.push({status:986,statusText:c+": value is not a valid number"});
b.minInclusive&&d<b.minInclusive&&g.push({status:986,statusText:c+": integer value must be larger than "+b.minInclusive});b.maxInclusive&&d>b.maxInclusive&&g.push({status:986,statusText:c+": integer value must be smaller than "+b.maxInclusive});break;case "xs:double":d=parseFloat(d);isNaN(d)&&g.push({status:986,statusText:c+": value is not a valid number"});b.minInclusive&&d<b.minInclusive&&g.push({status:986,statusText:c+": double value must be larger than "+b.minInclusive});b.maxInclusive&&d>b.maxInclusive&&
g.push({status:986,statusText:c+": double value must be smaller than "+b.maxInclusive});break;case "xs:string":Array.isArray(d)?"number"==typeof b.maxLength&&0>h.dontCheck.indexOf("text.length")&&d.forEach(function(k){k.text.length>b.maxLength&&0>h.dontCheck.indexOf("text.length")&&g.push({status:986,statusText:c+": length of string value must not exceed "+b.maxLength})}):g.push({status:986,statusText:c+": value must be a list of multi-language objects"})}}}))}function y(a,e,c){e.forEach(function(b){function d(r){r&&
(k=k.concat(r.propertyClasses||[]),"object"==typeof r["extends"]&&d(p(a,r["extends"])))}let k=[],l,m,n=p(a,b[c]);n&&(d(n),Array.isArray(b.properties)&&b.properties.forEach(function(r){l="property with class '"+r["class"].id+"' of instance with identifier '"+b.id+"'";q(k,r["class"])&&g.push({status:987,statusText:l+": class must be listed with the instance class or a parent instance class"});m=p(f.propertyClasses,r["class"]);"object"==typeof m?v(m,r.values,l):g.push({status:987,statusText:l+" must reference a valid propertyClass"})}))})}
function z(a,e,c){Array.isArray(e)&&e.forEach(function(b){q(a,b.resource)&&g.push({status:988,statusText:"hierarchy node with identifier '"+b.id+"' must reference a valid resource"});z(a,b.nodes,c+1)})}function A(a){return{id:a.id,revision:a.revision}}function w(a){if(Array.isArray(a)){let c=1<a.length;for(var e=a.length-1;-1<e;e--){let b=a[e];if("string"!=typeof b.text||c&&0<e&&("string"!=typeof b.language||2>b.language.length))return!1}return!0}return!1}function p(a,e){a=a.filter(function(c){return c.id==
e.id});if(!(1>a.length)){if(1==a.length&&!a[0].revision)return e.revision?void 0:a[0];a.sort(function(c,b){return b.changedAt-c.changedAt});if(!e.revision)return a[0];a=a.filter(function(c){return c.revision==e.revision});if(0<a.length)return a[0]}}function q(a,e){return void 0==p(a,e)}function B(a){var e="";a.forEach(function(c){e+=(e.length?",\n":"")+c.statusText+" ("+status+")"});return e}if(f.specifVersion)return{status:971,statusText:"This constraint checker does not support any SpecIF version below 1.1"};
switch(f.$schema){case "https://specif.de/v1.1/schema.json":case "https://json.schemastore.org/specif-1.1.json":break;case "https://specif.de/v1.0/schema.json":case "https://json.schemastore.org/specif-1.0.json":return{status:971,statusText:"This constraint checker does not support SpecIF version 1.0"};default:return{status:972,statusText:"Invalid schema location"}}"object"!=typeof h&&(h={});Array.isArray(h.doCheck)||(h.doCheck=[]);Array.isArray(h.dontCheck)||(h.dontCheck=[]);let x=this;var g=[];
(function(){function a(c){if(Array.isArray(c)&&0<c.length)for(var b,d=c.length-1;-1<d;d--)if(void 0!=c[d].id){a:{let m;b=e;var k=c[d];let n=k.revision||"";for(var l=b.length-1;-1<l;l--)if(m=b[l].revision||"",b[l].id==k.id&&(m==n||""==m||""==n)){b=!0;break a}b=!1}if(b)return c[d];if((b=a(c[d].enumeration))||(b=a(c[d].nodes)))return b;e.push(A(c[d]))}}let e=[A(f)];[{list:f.dataTypes,name:"dataType or enumerated value"},{list:f.propertyClasses,name:"propertyClass"},{list:f.resourceClasses,name:"resourceClass"},
{list:f.statementClasses,name:"statementClass"},{list:f.resources,name:"resource"},{list:f.statements,name:"statement"},{list:f.hierarchies,name:"hierarchy or node"},{list:f.files,name:"file"}].forEach(function(c){let b=a(c.list);b&&g.push({status:973,statusText:"key of "+c.name+" '"+b.id+"' with revision "+b.revision+" is not unique"})})})();(function(){f.dataTypes.forEach(function(a){switch(a.type){case "xs:double":case "xs:integer":"number"==typeof a.minInclusive&&"number"==typeof a.maxInclusive&&
a.minInclusive+1>a.maxInclusive&&g.push({status:974,statusText:"dataType '"+a.id+"': minInclusive must be smaller or equal than maxInclusive"});case "xs:dateTime":case "xs:anyURI":case "xs:string":if(Array.isArray(a.enumeration))if(0<a.enumeration.length)for(var e=a.enumeration.length-1;-1<e;e--)"xs:string"==a.type?w(a.enumeration[e].value)||g.push({status:974,statusText:"dataType '"+a.id+"' of type 'xs:string' must have enumerated values, each with a list of multi-language texts"}):"string"!=typeof a.enumeration[e].value&&
g.push({status:974,statusText:"dataType '"+a.id+"' of type '"+a.type+"' must have enumerated string values"});else g.push({status:974,statusText:"dataType '"+a.id+"' must have at least one enumerated value"})}})})();(function(){f.propertyClasses.forEach(function(a){q(f.dataTypes,a.dataType)&&g.push({status:975,statusText:"property class with identifier '"+a.id+"' must reference a valid dataType"});v(a,a.values,"property class '"+a.id+"'")})})();(function(){f.resourceClasses.forEach(function(a){u(a,
"resourceClass")});t(f.resourceClasses,f.resourceClasses,"extends","resourceClass")})();(function(){let a=f.resourceClasses.concat(f.statementClasses);f.statementClasses.forEach(function(e){u(e);["subjectClasses","objectClasses"].forEach(function(c){if(h.doCheck.includes("statementClass."+c)){var b=e[c];b=Array.isArray(b)&&1>b.length?!0:!1;b&&g.push({status:978,statusText:c+" of class '"+e.id+"' must reference at least one valid resourceClass or statementClass"});a:{b=e[c];if(Array.isArray(b))for(var d=
b.length-1;-1<d;d--)if(q(a,b[d])){b=!0;break a}b=!1}b&&g.push({status:978,statusText:c+" of class '"+e.id+"' references at least one invalid resourceClass or statementClass"})}})});t(f.statementClasses,f.statementClasses,"extends","statementClass")})();t(f.resourceClasses,f.resources,"class","resourceClass");y(f.resourceClasses,f.resources,"class");(function(){t(f.statementClasses,f.statements,"class","statementClass");let a=f.resources.concat(f.statements),e=f.resourceClasses.concat(f.statementClasses);
f.statements.forEach(function(c,b){let d=p(a,c.subject),k=p(a,c.object);!d&&0>h.dontCheck.indexOf("statement.subject")&&g.push({status:980,statusText:"subject of statement["+b+"] with identifier '"+c.id+"' must reference a valid resource or statement"});!k&&0>h.dontCheck.indexOf("statement.object")&&g.push({status:980,statusText:"object of statement["+b+"] with identifier '"+c.id+"' must reference a valid resource or statement"});d&&k&&d.id==k.id&&d.revision!=k.revision&&g.push({status:980,statusText:"subject and object of statement["+
b+"] with identifier '"+c.id+"' may have the same id, but not of different revisions"});let l=p(f.statementClasses,c["class"]);if(l){if(Array.isArray(l.subjectClasses)&&d){let m=[];l.subjectClasses.forEach(function(n){(n=p(e,n))&&m.push(n)});q(m,d["class"])&&g.push({status:981,statusText:"the subject of statement["+b+"] with identifier '"+c.id+"' has a class which is not listed in the subjectClasses of the statement's class"})}if(Array.isArray(l.objectClasses)&&k){let m=[];l.objectClasses.forEach(function(n){(n=
p(e,n))&&m.push(n)});q(m,k[["class"]])&&g.push({status:981,statusText:"the object of statement["+b+"] with identifier '"+c.id+"' has a class which is not listed in the objectClasses of the statement's class"})}}else g.push({status:982,statusText:"the class of statement["+b+"] with identifier '"+c.id+"' has not been found"})});y(f.statementClasses,f.statements,"class")})();z(f.resources,f.hierarchies,0);return 1>g.length?{status:0,statusText:"SpecIF constraints have been checked successfully!"}:{status:973,
statusText:"SpecIF constraints are violated",responseType:"text",responseText:B(g)}}};